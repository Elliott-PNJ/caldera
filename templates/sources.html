<div x-data="alpineSources()" x-init="getSources()" id="sourcePage" xmlns:x-bind="http://www.w3.org/1999/xhtml"
     xmlns:x-on="http://www.w3.org/1999/xhtml">

    <!-- PAGE HEADER -->
    <div x-ref="headerSources">
        <h2>Fact Sources</h2>
        <p>
            Facts are identifiable pieces of data, collected by agents or loaded when the server starts.
            A source is a collection of facts. Rules are boundaries to ensure specific traits cannot be used.
        </p>
    </div>
    <hr>


    <!-- SOURCES TABLE -->
    <div class="columns">
        <!-- LEFT SIDEBAR -->
        <div class="column m-0 is-2 filters">
            <label x-show="false" class="label">Select a source &nbsp;&nbsp;&nbsp;</label>
            <div class="select is-small is-fullwidth mb-2">
                <select x-on:change="getSource()" x-model="selectedSourceId">
                    <option value="" default disabled selected>Select a source...</option>
                    <template x-for="source of sources" :key="source.id">
                        <option x-bind:value="source.id" x-text="source.name"></option>
                    </template>
                </select>
            </div>
            <button type="button" class="button is-primary is-small is-fullwidth mb-4" @click="createSource()"><span
                    class="icon"><em class="fas fa-plus"></em></span><span>Create Source</span></button>

            <label for="sourceName" x-show="false" class="label">Source Name</label>

            <div class="has-text-centered" x-show="selectedSourceId && !isEditingSourceName">
                <h3 x-text="selectedSource.name" class="pointer tooltip has-tooltip-arrow mt-0 mb-5"
                    data-tooltip="Click to edit" @click="isEditingSourceName = true"></h3>
            </div>
            <input x-show="selectedSourceId && isEditingSourceName"
                   @click.outside="isEditingSourceName = false"
                   id="sourceName" class="input mb-5" placeholder="Enter a source name" x-model="selectedSource.name">


            <template x-if="!selectedSourceId">
                <p class="is-flex is-justify-content-center is-italic mt-2">Select a fact source to get started.</p>
            </template>

            <div class="control-buttons is-flex is-fullwidth is-flex-direction-column">
                <button class="button is-small mb-2"
                        @click="openModal = { isOpen: true, name: 'Add From Ability' }; filterAbilities()">
                    <span class="icon"><em class="fas fa-plus"></em></span>
                    <span>Facts from Ability</span>
                </button>
                <button class="button is-small mb-2"
                        @click="openModal = { isOpen: true, name: 'Add From Adversary' }; getAdversaries();">
                    <span class="icon"><em class="fas fa-user-plus"></em></span>
                    <span>Facts from Adversary</span>
                </button>
                <button class="button is-small mb-2" @click="duplicateSource(selectedSource)">
                    <span class="icon"><em class="fas fa-copy"></em></span>
                    <span>Duplicate Source</span>
                </button>
                <div class="hr"></div>
                <button class="button is-small mb-2 is-danger is-outlined"
                        @click="openModal = { isOpen: true, name: 'Delete Source' }">
                    <span class="icon"><em class="fas fa-trash"></em></span>
                    <span>Delete Source</span>
                </button>
            </div>
        </div>

        <template x-if="selectedSourceId">
        <!-- RIGHT SIDEBAR -->
            <div class="column m-0 pt-0 sources-view is-10" x-data="{inView: ['facts']}">
                <!-- TOPBAR CHIPS-->
                <div class="is-flex is-align-items-center">
                    <template x-for="chip of ['facts', 'rules', 'relationships']">
                        <button class="is-small button is-rounded m-1" x-on:click="inView = [chip]"
                              x-text="chip" x-bind:class="{'is-primary': inView.includes(chip)}"></button>
                    </template>
                    <!--                        TODO-->
                    <button class="button is-rounded is-small"><em class="fas fa-sort"></em></button>
                </div>
<!--                <div class="hr"></div>-->

                <template x-if="inView.includes('facts')">
                    <!-- FACTS -->
                    <div class="mt-2 is-flex is-flex-wrap-wrap is-align-content-flex-start">
                        <div class="box sources add-new mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center"
                             x-on:click="addNewCard = true">
                            <p class="is-italic">+ new fact</p>
                        </div>
                        <template x-if="addNewCard">
                            <div x-data="{newFact: {trait: '', value: '', score: ''}}" class="box sources mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center is-flex-direction-column">
                                <label class="label" x-show="false" for="new-fact-trait">Fact trait</label>
                                <input id="new-fact-trait" class="input mb-5" placeholder="fact trait" x-model="newFact.trait">
                                <input id="new-fact-value" class="input mb-5 is-small" placeholder="fact value" x-model="newFact.value">
                                <input id="new-fact-score" class="input mb-5 is-small" type="number" pattern="[0-9]*" min="0" placeholder="1" placeholder="fact score" x-model="newFact.score">
                                <div>
                                    <button class="button is-small" @click="addNewCard = false">
                                        <span>Cancel</span>
                                    </button>
                                    <button class="button is-small is-primary" @click="addFact(newFact)" x-bind:disabled="!newFact.trait">
                                        <span class="icon"><i class="fas fa-save"></i></span>
                                        <span>Save</span>
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-for="(fact, index) in filteredFacts" :key="fact.trait">
                            <div class="box sources mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center is-flex-direction-column">
                                <p class="has-background-warning has-text-black is-italic" x-text="fact.trait"></p>
                                <div class="is-flex is-justify-content-center is-flex-direction-row">
                                    <div class="is-flex is-justify-content-center is-align-items-center is-flex-direction-column">
                                        <label x-show="fact.scores" class="label is-italic mb-0 is-size-7" x-text="'Values'"></label>
                                        <div>
                                            <template x-for="(score, index) in fact.scores" :key="fact.trait + score.score">
                                                <div class="is-flex is-justify-content-center is-align-items-center is-flex-direction-row is-flex-wrap-wrap">
                                                    <label x-show="fact.scores" class="label is-italic mb-0 is-size-7 pr-1" x-text="score.score + ' pt:'"></label>
                                                    <template x-for="(val, index) in score.values" :key="val">
                                                        <span class="is-italic tag is-light" x-text="val"></span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- RULES -->
                <template x-if="inView.includes('rules')">
                    <div class="mt-2 is-flex is-flex-wrap-wrap is-align-content-flex-start">
                        <div class="box sources add-new mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center">
                            <p class="is-italic">+ new rule</p>
                        </div>
                        <template x-for="(rule, index) in filteredRules" :key="rule.trait">
                            <div class="box sources mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center is-flex-direction-column">
                                <p x-text="rule.trait"></p>
                                <div class="is-size-7">
                                    <template x-if="rule.allow_matches.length > 0">
                                        <label class="label is-italic mb-0 is-inline-block">Allow: </label>
                                    </template>
                                    <template x-for="(match, index) in rule.allow_matches" :key="match">
                                        <p class="tag is-success is-italic m-1 break-spaces"
                                           x-text="match">
                                        </p>
                                    </template>
                                </div>
                                <div class="is-size-7">
                                    <template x-if="rule.deny_matches.length > 0">
                                        <label class="label is-italic mb-0 is-inline-block">Deny: </label>
                                    </template>
                                    <template x-for="(match, index) in rule.deny_matches" :key="match">
                                        <p class="tag is-danger is-italic m-1 break-spaces"
                                           x-text="match">
                                        </p>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- RELATIONSHIPS -->
                <template x-if="inView.includes('relationships')">
                    <div class="mt-2 is-flex is-flex-wrap-wrap is-align-content-flex-start">
                        <div class="box sources add-new mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center">
                            <p class="is-italic">+ new relationship</p>
                        </div>
                        <template x-for="(relationship, index) in filteredRelationships" :key="relationship.trait">
                            <div class="box sources mb-2 mr-2 p-3 is-flex is-justify-content-center is-align-items-center is-flex-direction-column">
                                <p x-text="relationship.trait"></p>
                                    <template x-for="(rel, index) in relationship.relationships" :key="rel">
                                        <div class="is-size-7" x-bind:class="{'pr-2': index > 0}">
                                            <span class="tag is-outlined is-light is-italic m-1 break-spaces" x-text="rel.from"></span>
                                            <em class="has-text-white fas fa-arrow-right"></em>
                                            <span class="tag is-outlined is-light is-italic m-1 break-spaces" x-text="rel.to"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </template>
    </div>


    <!-- MODALS -->
    <div class="modal" x-bind:class="{ 'is-active': openModal.isOpen }">
        <div class="modal-background" @click="openModal.isOpen = false"></div>
        <template x-if="openModal.name.includes('Delete')">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Delete Fact Source?</p>
                </header>
                <section class="modal-card-body">
                    <p>
                        Are you sure you want to delete this fact source? This cannot be undone.
                    </p>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Cancel</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button class="button is-danger is-small"
                                        @click="deleteSource(); openModal.isOpen = false;">
                                    <span class="icon"><em class="fas fa-trash"></em></span>
                                    <span class="has-text-weight-bold">Delete Source</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
        <template x-if="openModal.name.includes('Ability')" x-data="{selectedAbility: null}">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add Fact from Ability </p>
                </header>
                <section class="modal-card-body">
                    <form>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label"><span class="icon is-small"><em class="fas fa-search"></em></span></label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <input class="input is-small" x-model="abilitySearch.query"
                                               placeholder="Search for an ability..." x-on:keyup="filterAbilities()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label">Tactic</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="link-tactic" x-model="abilitySearch.tactic"
                                                    x-on:change="filterAbilities()">
                                                <option default value="">All tactics</option>
                                                <template x-for="tactic in tactics" :key="tactic">
                                                    <option x-text="tactic"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label">Technique</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="link-technique" x-model="abilitySearch.technique"
                                                    x-on:change="filterAbilities()">
                                                <option default value="">All techniques</option>
                                                <template x-for="technique in techniques" :key="technique">
                                                    <option x-text="technique"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr>
                    <div class="is-flex is-justify-content-space-between mb-2">
                        <strong x-show="filteredAbilities.length">Select an ability</strong>
                    </div>
                    <template x-for="ability in filteredAbilities" :key="ability.ability_id">
                        <div class="box selectable mb-2 mr-2 p-3 has-background-black-ter"
                             x-bind:class="{'selected': selectedAbility === ability}"
                             @click="selectedAbility = ability">
                            <p class="mb-0">
                                <span class="has-text-weight-bold" x-text="ability.name"></span>
                                <span x-text="`${ability.technique_id}`"></span>
                            </p>
                            <div class="is-flex is-align-items-center">
                                <label class="is-italic is-size-7 break-spaces" for="ability-fact-score">Score: </label>
                                <input class="input has-background-grey-darker is-small m-2 w-50-px"
                                       id="ability-fact-score" x-model="ability.score" type="number" required
                                       pattern="[0-9]*" min="0" placeholder="1"/>
                            </div>
                            <p x-show="ability.factTraits" class="is-italic is-size-7">
                                <span>Facts: </span>
                                <template x-for="fact in ability.factTraits">
                                    <span class="has-background-warning has-text-black mr-2 px-1"
                                          x-text="`${fact}`"></span>
                                </template>
                            </p>
                            <p class="is-size-7" x-text="ability.description"></p>
                        </div>
                    </template>
                    <template x-if="filteredAbilities.length === 0">
                        <p class="is-size-7 is-italic ml-4 text-align-center">No results, try
                            <button class="no-style button-link is-italic has-text-white is-size-7 px-0"
                                    alt="click to reset search" @click="resetSearch()">
                                resetting search
                            </button>
                            ?
                        </p>
                    </template>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Done</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button x-bind:disabled="!selectedAbility" class="button is-primary is-small"
                                        @click="addFromAbility(selectedAbility.factTraits, selectedAbility.score); openModal.isOpen = false">
                                    <span>Add Facts</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
        <template x-if="openModal.name.includes('Adversary')" x-data="{selectedAdversary: ''}">
            <div class="modal-card" style="z-index: 20">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add Fact from Adversary</p>
                </header>
                <section class="modal-card-body">
                    <form>
                        <div class="field is-horizontal">
                            <div class="field-label is-small">
                                <label class="label" for="sourcesAdversaryDropdown">Adversary</label>
                            </div>
                            <div class="field-body">
                                <div class="field">
                                    <div class="control">
                                        <div class="select is-small is-fullwidth">
                                            <select id="sourcesAdversaryDropdown"
                                                    x-on:change="filteredAbilities = []; getAdversaryFacts(selectedAdversary)"
                                                    x-model="selectedAdversary">
                                                <option value="" default disabled selected>Select one...</option>
                                                <template x-for="adversary of adversaries"
                                                          :key="adversary.adversary_id">
                                                    <option x-bind:value="adversary.adversary_id"
                                                            x-text="adversary.name"
                                                            x-bind:title="adversary.description"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <template x-if="selectedAdversary">
                        <span>
                            <hr>
                            <div class="is-flex is-justify-content-space-between mb-2">
                                <strong x-show="selectedAdversary" x-text="'Adversary Abilities'"></strong>
                            </div>
                            <template x-if="filteredAbilities.length < 1">
                                <div class="box mb-2 mr-2 p-3 has-background-black-ter">
                                    <p class="text-align-center is-italic">This adversary has no facts available.</p>
                                </div>
                            </template>
                            <template x-if="filteredAbilities.length > 0">
                                <span>
                                    <template x-for="(ability, index) in filteredAbilities" :key="index">
                                        <div class="box mb-2 mr-2 p-3 has-background-black-ter">
                                            <p>
                                                <span class="has-text-weight-bold" x-text="ability.name"></span>
                                                <span x-text="`${ability.technique_id}`"></span>
                                            </p>
                                            <div class="is-flex is-align-items-center">
                                                <label class="is-italic is-size-7"
                                                       for="adversary-fact-score">Score: </label>
                                                <input class="input has-background-grey-darker is-small m-2 w-50-px"
                                                       id="adversary-fact-score" x-model="ability.score" type="number"
                                                       required pattern="[0-9]*" min="0" placeholder="1"/>
                                            </div>
                                            <p x-show="ability.factTraits" class="is-italic is-size-7">
                                                <span>Facts: </span>
                                                <template x-for="fact in ability.factTraits">
                                                    <span class="has-background-warning has-text-black mr-2 px-1"
                                                          x-text="`${fact}`"></span>
                                                </template>
                                            </p>
                                            <p class="is-size-7" x-text="ability.description"></p>
                                        </div>
                                    </template>
                                </span>
                            </template>
                        </span>
                    </template>
                </section>
                <footer class="modal-card-foot">
                    <nav class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <button class="button is-small" @click="openModal.isOpen = false">Done</button>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button x-bind:disabled="filteredAbilities.length < 1"
                                        class="button is-primary is-small"
                                        @click="addFromAdversary(); openModal.isOpen = false">
                                    <span>Add All Facts</span>
                                </button>
                                <div>
                                </div>
                    </nav>
                </footer>
            </div>
        </template>
    </div>
</div>

<script>
    function alpineSources() {
        return {
            sources: [],
            filteredFacts: [],
            filteredRules: [],
            filteredRelationships: [],

            selectedSource: {
                name: '',
                relationships: []
            },
            selectedSourceId: '',
            selectedRelationshipIndex: null,
            selectedFactIndex: null,
            selectedRuleIndex: null,

            isEditingSourceName: false,

            openModal: {
                isOpen: false,
                name: ''
            },
            tactics: [],
            techniques: [],
            filteredAbilities: [],
            abilitySearch: {
                query: '',
                tactic: '',
                technique: null
            },
            abilities: [],
            adversaries: [],

            factIndexToDelete: -1,
            ruleIndexToDelete: -1,
            relationshipIndexToDelete: -1,

            addNewCard: false,

            newRelationship: {
                sourceTrait: '',
                edge: '',
                targetTrait: ''
            },

            getSources() {
                apiV2('GET', '/api/v2/sources').then((sources) => {
                    this.sources = sources.sort((a, b) => a.name.toLowerCase() > b.name.toLowerCase());
                    this.getSource();
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            getSource() {
                if (!this.selectedSourceId) return;
                this.selectedSource = this.sources.find((source) => source.id === this.selectedSourceId);

                const facts = {};
                this.selectedSource.facts.forEach((f) => {
                    if (!(facts[f.trait])) {
                        const vals = {};
                        vals[f.score] = [...f.value.split(',')];
                        facts[f.trait] = {
                            trait: f.trait,
                            scores: vals
                        };
                    } else {
                        const vals = {};
                        vals[f.score] = [...f.value.split(',')];
                        if (!facts[f.trait].scores[f.score]) {
                            facts[f.trait].scores[f.score] = {score: f.score, values: vals};
                        } else {
                            facts[f.trait].scores[f.score].values = [
                                ...facts[f.trait].scores[f.score].values,
                                ...vals[f.score]
                            ]
                        }
                    }
                });

                let rules = {};
                this.selectedSource.rules.forEach((rule) => {
                    if (rules[rule.trait]) {
                        if (rule.action === 'ALLOW') {
                            rules[rule.trait].allow_matches.push(rule.match)
                        } else if (rule.action === 'DENY') {
                            rules[rule.trait].deny_matches.push(rule.match)
                        }
                    } else {
                        if (rule.action === 'ALLOW') {
                            rules[rule.trait] = {trait: rule.trait, allow_matches: [rule.match], deny_matches: []};
                        } else if (rule.action === 'DENY') {
                            rules[rule.trait] = {trait: rule.trait, allow_matches: [], deny_matches: [rule.match]};
                        }
                    }
                });

                let relationships = {};
                this.selectedSource.relationships.forEach((r) => {
                    if (relationships[r.edge]) {
                        relationships[r.edge].relationships.push({from: r.source.name, to: r.target.name});
                    } else {
                        relationships[r.edge] = {trait: r.edge, relationships: [{from: r.source.name, to: r.target.name}]};
                    }
                });

                this.filteredFacts = Object.keys(facts).map(key => {
                    const fact = facts[key];
                    fact.scores = Object.keys(fact.scores).map(s => ({ score: s, values: facts[key].scores[s] }));
                    return fact;
                });
                this.filteredRules = Object.keys(rules).map(key => rules[key]);
                this.filteredRelationships = Object.keys(relationships).map(key => relationships[key]);
            },

            createSource() {
                this.isEditingSourceName = true;
                const newSource = {
                    name: 'New source',
                    facts: [],
                    rules: [],
                    relationships: []
                };
                apiV2('POST', '/api/v2/sources', newSource).then((src) => {
                    toast('Added new fact source', true);
                    this.isEditingSourceName = true;
                    this.sources.push(src);
                    this.selectedSourceId = src.id;
                    this.selectedSource = src;
                    this.getSource();
                    this.$nextTick(() => {
                        document.getElementById('sourceName').focus();
                    });
                }).catch((error) => {
                    toast('Error adding source', false);
                    console.error(error);
                });
            },

            getFilters(abilities) {
                abilities.forEach((a) => {
                    this.tactics.push(a.tactic);
                    this.techniques.push(`${a.technique_id} | ${a.technique_name}`);
                });
                this.tactics = [...new Set(this.tactics)].sort();
                this.techniques = [...new Set(this.techniques)].sort();
            },

            filterAbilities() {
                apiV2('GET', '/api/v2/abilities').then((abilities) => {
                    this.getFilters(abilities);
                    this.filteredAbilities = getFilteredAbilities(abilities, this.abilitySearch.query, this.abilitySearch.tactic, this.abilitySearch.technique);
                    this.getAbilityFacts();
                }).catch((error) => {
                    toast('There was an error getting abilities', false);
                    console.error(error);
                });
            },

            getAbilityFacts() {
                let abilitiesWithFacts = [];
                this.filteredAbilities.forEach((a) => {
                    let factTraits = [];
                    if (a.executors) {
                        a.executors.forEach((e) => {
                            if (e.command) {
                                const m = [...e.command.matchAll(/#{(.*?)}/gm)];
                                if (m && m.length > 0) factTraits = factTraits.concat(m.map((variable) => variable[1])); // find all abilities where an executor has a command with a ${} fact variable
                            }
                        });
                        if (factTraits.length > 0) {
                            abilitiesWithFacts.push({
                                ...a,
                                score: 1,
                                factTraits: [...new Set(factTraits)]
                            });
                        }
                    }
                });
                this.filteredAbilities = abilitiesWithFacts;
            },

            addFromAbility(factTraits, score, fromAdversary = false) { // add all facts found from abilities
                this.openModal.isOpen = false;
                factTraits.forEach((val) => {
                    this.addFact({
                        trait: val,
                        value: '',
                        score: score
                    }, true);
                });
                if (!fromAdversary) toast('Added facts to source', true);
            },

            getAdversaries() {
                apiV2('GET', '/api/v2/adversaries').then((adversaries) => {
                    this.adversaries = adversaries;
                    return apiV2('GET', '/api/v2/abilities');
                }).then((abilities) => {
                    this.abilities = abilities;
                }).catch((error) => {
                    toast('Error getting adversaries', false);
                    console.error(`Error getting adversaries: ${error}`);
                });
            },

            getAdversaryFacts(selectedAdversaryID) {
                const selectedAdversary = this.adversaries.find((adversary) => adversary.adversary_id === selectedAdversaryID);
                this.filteredAbilities = selectedAdversary.atomic_ordering.map((ability_id) => ({ ...this.abilities.find((ability) => ability.ability_id === ability_id) }));
                this.getAbilityFacts();
            },

            addFromAdversary() {
                this.filteredAbilities.forEach((a) => {
                    if (a.factTraits) {
                        this.addFromAbility(a.factTraits, a.score, true);
                    }
                });
            },

            duplicateSource(source) {
                const newSource = {
                    ...source,
                    name: `${source.name} (copy)`,
                    id: ''
                };
                apiV2('POST', '/api/v2/sources', newSource).then((src) => {
                    this.sources.push(src);
                    this.selectedSourceId = src.id;
                    this.selectedSource = src;
                    this.getSource();
                    toast('Duplicated fact source', true);
                }).catch((error) => {
                    toast('Error duplicating source', false);
                    console.error(error);
                });
            },

            addFact(newFact, bulkAdd = false) {
                const updatedSource = { ...this.selectedSource };
                updatedSource.facts.push(newFact);
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    if (!bulkAdd) toast('Updated source', res);
                    this.showAddFactRow = false;
                    this.getSources();
                    this.addNewCard = false;
                }).catch((error) => {
                    toast('Error adding fact', false);
                    console.error(error);
                });
            },

            validateRule(newRule) {
                return !this.selectedSource.rules.find((r) => (r.match === newRule.match && r.trait === newRule.trait));
            },

            addRule(newRule) {
                if (!this.validateRule(newRule)) {
                    toast('Error: Rule already exists');
                    return;
                }
                const updatedSource = { ...this.selectedSource };
                updatedSource.rules.push(newRule);
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    toast('Updated source', true);
                    this.showAddRuleRow = false;
                    this.getSources();
                }).catch((error) => {
                    toast('Error adding rule', false);
                    console.error(error);
                });
            },

            addRelationship() {
                const updatedSource = { ...this.selectedSource };
                updatedSource.relationships.push({
                    source: { trait: this.newRelationship.sourceTrait },
                    target: { trait: this.newRelationship.targetTrait },
                    edge: this.newRelationship.edge
                });
                apiV2('PUT', `/api/v2/sources/${this.selectedSource.id}`, updatedSource).then((res) => {
                    toast('Updated source', true);
                    this.showAddRelationshipRow = false;
                    this.newRelationship.sourceTrait = '';
                    this.newRelationship.targetTrait = '';
                    this.newRelationship.edge = '';
                    this.getSources();
                }).catch((error) => {
                    toast('Error adding relationship', false);
                    console.error(error);
                });
            },

            deleteSource() {
                apiV2('DELETE', `/api/v2/sources/${this.selectedSourceId}`).then((res) => {
                    toast('Deleted fact source', true);
                    this.selectedSourceId = '';
                    this.selectedSource = {
                        name: '',
                        relationships: []
                    };
                    this.getSources();
                }).catch((error) => {
                    toast('Error deleting source', false);
                    console.error(error);
                });
            },

            deleteFact(index) {
                this.selectedSource.facts.splice(index, 1);
                this.factIndexToDelete = -1;
                this.updateFactSource();
            },

            deleteRule(index) {
                this.selectedSource.rules.splice(index, 1);
                this.ruleIndexToDelete = -1;
                this.updateFactSource();
            },

            deleteRelationship(index) {
                this.selectedSource.relationships.splice(index, 1);
                this.relationshipIndexToDelete = -1;
                this.updateFactSource();
            },

            saveSourceName() {
                if (!this.selectedSource.name) {
                    toast('Source name cannot be blank', false);
                    return;
                }

                apiV2('PATCH', `/api/v2/sources/${this.selectedSource.id}`, { name: this.selectedSource.name }).then(() => {
                    toast('Source name updated', true);
                    this.isEditingSourceName = false;
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            editSource(fact = {trait: '', scores: []}) {

            },

            updateFactSource(source = this.selectedSource) {
                apiV2('PATCH', `/api/v2/sources/${this.selectedSource.id}`, source).then(() => {
                    toast('Updated source', true);
                    this.getSources();
                }).catch((error) => {
                    toast('Error loading page', false);
                    console.error(error);
                });
            },

            resetSearch() {
                this.abilitySearch = {
                    query: '',
                    tactic: '',
                    technique: null
                };
                this.filterAbilities();
            },
        };
    }

    // # sourceURL=sources.js
</script>

<style scoped>
    .filters {
        border-right: 1px solid rgb(97, 97, 97);
    }

    .hr {
        content: "";
        height: 1px;
        background-color: rgb(97, 97, 97);
        margin: 0.5em 0 1em;
    }

    button.no-style {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    .button.no-style:focus, .button.no-style.is-focused {
        color: white;
    }

    @media (max-width: 900px) {
        .box.sources {
            width: 98%;
        }
    }

    @media (min-width: 900px) and (max-width: 1300px) {
        .box.sources {
            width: 48%;
        }
    }

    @media (min-width: 1300px) {
        .box.sources {
            width: 32%;
        }
    }

    .box.sources {
        position: relative;
        cursor: text;
        border: 1px solid transparent;
        background-color: #272727;
        word-break: break-word;
    }

    .box.sources:hover {
        border: 1px solid #474747;
    }

    .box.sources.add-new {
        border: 2px solid #ffffff08;
    }

    .box.sources.add-new:hover {
        cursor: pointer;
        background-color: #ffffff38;
    }

    .break-spaces, .button.is-small {
        white-space: break-spaces;
        height: fit-content;
    }

    /*.sources-view {*/
    /*    height: calc(100vh - 160px);*/
    /*    overflow: scroll;*/
    /*}*/
</style>
